<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/labora_db/imagenes/logo-labora.png" type="image/x-icon"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Registro de Empleado - LABORA</title>
    <link rel="stylesheet" href="../recursos/css/styles.css">
    <link rel="stylesheet" href="../recursos/css/worker-registration.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
</head>

<body>
  <div class="header">
    <h1>LABORA</h1>
    <a href="../index.html">Volver al Inicio</a>
  </div>

  <div class="form-section">
    <h2>Registro de Empleado</h2>

    <!-- enctype para archivo -->
    <form action="../funciones/worker-register.php" method="POST" enctype="multipart/form-data" onsubmit="return validateForm()">
      <div class="input-group">
        <label for="emp-nombre">Nombre Completo</label>
        <input type="text" id="emp-nombre" name="nombre" required>
        <small class="error-text" data-error-for="emp-nombre"></small>
      </div>

      <div class="input-group">
        <label for="emp-dni">DNI</label>
        <input type="text" id="emp-dni" name="dni" required pattern="[0-9]{7,8}" title="Ingrese un DNI válido de 7 u 8 dígitos">
        <small class="error-text" data-error-for="emp-dni"></small>
      </div>

      <div class="input-group">
        <label for="emp-nacionalidad">Nacionalidad</label>
        <select id="emp-nacionalidad" name="nacionalidad" required>
            <option value="" disabled selected>Elegí una nacionalidad…</option>
            <option value="Argentina">Argentina</option>
            <option value="Chilena">Chilena</option>
            <option value="Brasilera">Brasilera</option>
        </select>
        <small class="error-text" data-error-for="emp-nacionalidad"></small>
      </div>

      <div class="input-group">
        <label for="emp-fecha-nacimiento">Fecha de Nacimiento</label>
        <input type="date" id="emp-fecha-nacimiento" name="fecha-nacimiento" required>
        <small class="error-text" data-error-for="emp-fecha-nacimiento"></small>
      </div>

      <div class="input-group">
        <label for="emp-email">Correo Electrónico</label>
        <input type="email" id="emp-email" name="email" required>
        <small class="error-text" data-error-for="emp-email"></small>
      </div>

      <div class="input-group">
        <label for="emp-password">Contraseña</label>
        <div class="password-container">
          <input type="password" id="emp-password" name="clave" required>
          <button type="button" class="toggle-password" onclick="togglePassword()">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <small class="error-text" data-error-for="emp-password"></small>
      </div>

      <div class="input-group">
        <label for="emp-confirm-password">Confirmar Contraseña</label>
        <div class="password-container">
          <input type="password" id="emp-confirm-password" name="confirm-password" required>
          <button type="button" class="toggle-password" onclick="toggleConfirmPassword()">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <small class="error-text" data-error-for="emp-confirm-password"></small>
      </div>

      <div class="input-group">
        <label for="emp-telefono">Teléfono</label>
        <input type="tel" id="emp-telefono" name="telefono" required
               inputmode="numeric" pattern="\d{10}" title="Ingresá 10 dígitos, sin espacios ni guiones">
        <small class="error-text" data-error-for="emp-telefono"></small>
      </div>

      <div class="input-group">
        <label for="emp-zona">Zona de trabajo</label>
        <select id="emp-zona" name="zona_trabajo" required>
            <option value="" disabled selected>Elegí una zona…</option>
            <option value="Moreno">Moreno</option>
            <option value="Paso del Rey">Paso del Rey</option>
            <option value="Merlo">Merlo</option>
            <option value="Padua">Padua</option>
            <option value="Padua">Ituzaingo</option>
        </select>
        <small class="error-text" data-error-for="emp-zona"></small>
      </div>

      <div class="input-group">
        <label for="emp-experiencia">Años de Experiencia</label>
        <input type="number" id="emp-experiencia" name="experiencia" min="0" required>
        <small class="error-text" data-error-for="emp-experiencia"></small>
      </div>

      <!-- Dropdown de selección ÚNICA de trabajo -->
      <div class="input-group" id="grupo-trabajo">
        <label for="emp-trabajo-trigger">Selecciona tu trabajo</label>

        <!-- Botón trigger -->
        <button type="button" id="emp-trabajo-trigger" class="ms-trigger" aria-haspopup="listbox" aria-expanded="false">
          <span class="ms-placeholder">Elegí una opción…</span>
          <i class="fas fa-chevron-down" aria-hidden="true"></i>
        </button>

        <!-- Menú (radios) -->
        <div class="ms-menu" role="listbox" aria-multiselectable="false" hidden>
          <label class="ms-option">
            <input type="radio" name="__trabajo_radio" value="carpinteria"> <i class="fas fa-hammer"></i> Carpintería
          </label>
          <label class="ms-option">
            <input type="radio" name="__trabajo_radio" value="plomeria"> <i class="fas fa-wrench"></i> Plomería
          </label>
          <label class="ms-option">
            <input type="radio" name="__trabajo_radio" value="educacion"> <i class="fas fa-chalkboard-teacher"></i> Educación
          </label>
          <label class="ms-option">
            <input type="radio" name="__trabajo_radio" value="electricidad"> <i class="fas fa-bolt"></i> Electricidad
          </label>
          <label class="ms-option">
            <input type="radio" name="__trabajo_radio" value="jardineria"> <i class="fas fa-leaf"></i> Jardinería
          </label>
          <label class="ms-option">
            <input type="radio" name="__trabajo_radio" value="pintura"> <i class="fas fa-paint-roller"></i> Pintura
          </label>
          <label class="ms-option">
            <input type="radio" name="__trabajo_radio" value="fletero"> <i class="fas fa-truck"></i> Fletero
          </label>
          <label class="ms-option">
            <input type="radio" name="__trabajo_radio" value="cerrajero"> <i class="fas fa-key"></i> Cerrajero
          </label>
        </div>

        <!-- Campo REAL que viaja al backend (único) -->
        <select id="emp-trabajo" name="trabajo" required hidden>
          <option value="" selected disabled>Elegí una opción…</option>
          <option value="carpinteria">Carpintería</option>
          <option value="plomeria">Plomería</option>
          <option value="educacion">Educación</option>
          <option value="electricidad">Electricidad</option>
          <option value="jardineria">Jardinería</option>
          <option value="pintura">Pintura</option>
          <option value="fletero">Fletero</option>
          <option value="cerrajero">Cerrajero</option>
        </select>

        <small class="error-text" data-error-for="emp-trabajo"></small>
      </div>
      <!-- FIN selección única -->

      <div class="input-group">
        <label for="emp-documentacion">Matricula (un archivo)</label>
        <input type="file" id="emp-documentacion" name="documentacion" accept=".pdf,.jpg,.jpeg,.png">
        <small class="file-hint">Formatos aceptados: PDF, JPG, JPEG, PNG.</small>
      </div>

      <div class="input-group">
        <label for="emp-documentacion">D.N.I FRENTE</label>
        <input type="file" id="emp-dni-frente" name="dni-frente" accept=".pdf,.jpg,.jpeg,.png">
        <small class="file-hint">Formatos aceptados: PDF, JPG, JPEG, PNG.</small>
      </div>

      <div class="input-group">
        <label for="emp-documentacion">D.N.I DORSO</label>
        <input type="file" id="emp-dni-dorso" name="dni-dorso" accept=".pdf,.jpg,.jpeg,.png">
        <small class="file-hint">Formatos aceptados: PDF, JPG, JPEG, PNG.</small>
      </div>

      <button type="submit">Registrarse</button>
    </form>

    <div id="message" class="message"></div>
  </div>

  <script>
    // ==== toggles de password ====
    function togglePassword() {
      const passwordInput = document.getElementById('emp-password');
      const icon = document.querySelector('.toggle-password i');
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }
    function toggleConfirmPassword() {
      const confirmPasswordInput = document.getElementById('emp-confirm-password');
      const icon = document.querySelectorAll('.toggle-password i')[1];
      if (confirmPasswordInput.type === 'password') {
        confirmPasswordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        confirmPasswordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    // ==== Dropdown selección ÚNICA de trabajo ====
    (function initTrabajoSingleSelect() {
      const trigger = document.getElementById('emp-trabajo-trigger');
      const menu = trigger.nextElementSibling; // .ms-menu
      const hiddenSelect = document.getElementById('emp-trabajo');
      const errEl = document.querySelector('[data-error-for="emp-trabajo"]');
      const placeholder = trigger.querySelector('.ms-placeholder');

      // abrir/cerrar
      trigger.addEventListener('click', () => {
        const isOpen = !menu.hasAttribute('hidden');
        if (isOpen) {
          menu.setAttribute('hidden', '');
          trigger.setAttribute('aria-expanded', 'false');
        } else {
          menu.removeAttribute('hidden');
          trigger.setAttribute('aria-expanded', 'true');
        }
      });

      // cerrar al click fuera
      document.addEventListener('click', (e) => {
        if (!menu.contains(e.target) && !trigger.contains(e.target)) {
          menu.setAttribute('hidden', '');
          trigger.setAttribute('aria-expanded', 'false');
        }
      });

      // elegir radio y sincronizar
      menu.querySelectorAll('input[type="radio"][name="__trabajo_radio"]').forEach((radio) => {
        radio.closest('.ms-option').addEventListener('click', (e) => {
          if (e.target.tagName !== 'INPUT') radio.checked = true;
          syncHiddenSelect(radio.value);
          refreshTriggerText();
          setError('');
          // cerrar menú al elegir
          menu.setAttribute('hidden', '');
          trigger.setAttribute('aria-expanded', 'false');
        });
      });

      function syncHiddenSelect(value) {
        Array.from(hiddenSelect.options).forEach(opt => {
          opt.selected = (opt.value === value);
        });
      }

      function refreshTriggerText() {
        const sel = hiddenSelect.value;
        if (!sel) {
          placeholder.textContent = 'Elegí una opción…';
          return;
        }
        const label = menu.querySelector(`input[value="${sel}"]`).parentElement.innerText.trim();
        placeholder.textContent = label;
      }

      function setError(msg) {
        errEl.textContent = msg || '';
        const group = document.getElementById('grupo-trabajo');
        if (msg) { group.classList.add('error'); } else { group.classList.remove('error'); }
      }

      // Exponer validación
      window.validateTrabajo = function () {
        if (!hiddenSelect.value) {
          setError('Seleccioná un trabajo');
          menu.removeAttribute('hidden');
          trigger.setAttribute('aria-expanded', 'true');
          return false;
        }
        setError('');
        return true;
      };
    })();

    // ==== Helpers UI de errores ====
    function ensureErrorNode(inputId) {
      const input = document.getElementById(inputId);
      const group = input.closest('.input-group') || input.parentElement;
      let node = group.querySelector(`small.error-text[data-error-for="${inputId}"]`);
      if (!node) {
        node = document.createElement('small');
        node.className = 'error-text';
        node.setAttribute('data-error-for', inputId);
        group.appendChild(node);
      }
      return node;
    }
    function setFieldError(inputId, msg) {
      const input = document.getElementById(inputId);
      const group = input.closest('.input-group') || input.parentElement;
      const node = ensureErrorNode(inputId);
      node.textContent = msg || '';
      if (msg) group.classList.add('error'); else group.classList.remove('error');
    }
    function clearAllErrors() {
      document.querySelectorAll('.input-group.error').forEach(g => g.classList.remove('error'));
      document.querySelectorAll('small.error-text').forEach(n => n.textContent = '');
    }

    // ==== Reglas cliente ====
    function isAdult(yyyy_mm_dd) {
      if (!yyyy_mm_dd) return false;
      const parts = yyyy_mm_dd.split('-');
      if (parts.length !== 3) return false;
      const d = new Date(+parts[0], +parts[1]-1, +parts[2]);
      if (isNaN(d)) return false;
      const today = new Date();
      const eighteen = new Date(d.getFullYear() + 18, d.getMonth(), d.getDate());
      return eighteen <= new Date(today.getFullYear(), today.getMonth(), today.getDate());
    }
    function passwordOK(pw) {
      // mín 8, al menos 1 letra y 1 número
      return /^(?=.*[A-Za-z])(?=.*\d).{8,}$/.test(pw);
    }

    // ==== Validación general ====
    function validateForm() {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = '';
      clearAllErrors();

      const ALLOWED_NAC = ['Argentina', 'Chilena', 'Brasilera'];
      const ALLOWED_ZONAS = ['Merlo', 'Moron', 'Padua', 'Ituzaingo'];

      let ok = true;

      // Trabajo
      if (!window.validateTrabajo || !window.validateTrabajo()) {
        ok = false;
      }

      // Fecha de nacimiento >= 18
      const fecha = document.getElementById('emp-fecha-nacimiento').value;
      if (!isAdult(fecha)) {
        setFieldError('emp-fecha-nacimiento', 'Debés ser mayor de 18 años');
        ok = false;
      }

      // Contraseña
      const pw = document.getElementById('emp-password').value;
      const pw2 = document.getElementById('emp-confirm-password').value;
      if (!passwordOK(pw)) {
        setFieldError('emp-password', 'Mínimo 8 caracteres, incluir letras y números');
        ok = false;
      }
      if (pw !== pw2) {
        setFieldError('emp-confirm-password', 'Las contraseñas no coinciden');
        ok = false;
      }

      // Teléfono 10 dígitos
      const telRaw = document.getElementById('emp-telefono').value;
      const telDigits = (telRaw || '').replace(/\D/g, '');
      if (telDigits.length !== 10) {
        setFieldError('emp-telefono', 'Ingresá 10 dígitos (solo números)');
        ok = false;
      }

      // Nacionalidad
      const nac = document.getElementById('emp-nacionalidad').value || '';
      if (!ALLOWED_NAC.includes(nac)) {
        setFieldError('emp-nacionalidad', 'Elegí una nacionalidad válida');
        ok = false;
      }

      // Zona
      const zona = document.getElementById('emp-zona').value || '';
      if (!ALLOWED_ZONAS.includes(zona)) {
        setFieldError('emp-zona', 'Elegí una zona válida');
        ok = false;
      }

      if (!ok) {
        messageDiv.textContent = 'Revisá los campos marcados';
        return false;
      }

      messageDiv.textContent = 'Registro exitoso';
      return true;
    }

    // Limpieza de errores en interacción
    (function attachLiveClear() {
      const ids = [
        'emp-fecha-nacimiento','emp-password','emp-confirm-password',
        'emp-telefono','emp-nacionalidad','emp-zona','emp-trabajo',
        'emp-nombre','emp-dni','emp-email','emp-experiencia'
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const ev = (el.tagName === 'SELECT' || el.type === 'date') ? 'change' : 'input';
        el.addEventListener(ev, () => setFieldError(id, ''));
      });
    })();
  </script>
</body>
</html>
